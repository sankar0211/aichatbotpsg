<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PSG AI Chatbot</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="chat-container">
    <h2>
      PSG AI Chatbot
      <span style="font-size: 0.8rem; margin-left: auto;">Welcome, {{ user_email }}</span>
      <button id="theme-toggle">ðŸŒ“</button>
    </h2>

    <div id="chat-box">
      <div id="typing-indicator" style="display: none;" class="message-container">
        <img src="{{ url_for('static', filename='images/bot-avatar.png') }}" alt="Bot Avatar" class="bot-avatar">
        <div class="bot-msg"><span class="dot-typing"></span></div>
      </div>
    </div>

    <form id="chat-form">
      <input type="text" id="user-input" placeholder="Ask me anything about PSG..." required />
      <button type="submit">Send</button>
    </form>

    <p style="text-align:center; margin-top: 1rem;">
      <a href="{{ url_for('logout') }}">Logout</a>
    </p>
  </div>

  <script>
    const form = document.getElementById('chat-form');
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const themeToggle = document.getElementById('theme-toggle');
    const typingIndicator = document.getElementById('typing-indicator');

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = userInput.value.trim();
      if (!message) return;
      appendMessage('user', message);
      userInput.value = '';
      typingIndicator.style.display = 'flex';
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await response.json();
        typingIndicator.style.display = 'none';
        appendMessage('bot', data.reply || "Sorry, I couldn't understand that.");
      } catch (error) {
        console.error(error);
        typingIndicator.style.display = 'none';
        appendMessage('bot', 'Oops! Something went wrong. Please try again.');
      }
    });

    function appendMessage(sender, text) {
      const container = document.createElement('div');
      container.className = `message-container ${sender === 'user' ? 'user-container' : ''}`;

      const avatar = document.createElement('img');
      avatar.src = sender === 'user'
        ? "{{ url_for('static', filename='images/user-avatar.png') }}"
        : "{{ url_for('static', filename='images/bot-avatar.png') }}";
      avatar.alt = sender;
      avatar.className = sender === 'user' ? 'user-avatar' : 'bot-avatar';

      const msgDiv = document.createElement('div');
      msgDiv.className = sender === 'user' ? 'user-msg' : 'bot-msg';
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      msgDiv.innerHTML = `${text}<span class="timestamp">${timestamp}</span>`;

      container.appendChild(avatar);
      container.appendChild(msgDiv);

      chatBox.insertBefore(container, typingIndicator);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
